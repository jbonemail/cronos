<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Cronos natación</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
/* ====== BASE ====== */
:root{
  --bg:#f2f2f2; --panel:#fff; --border:#d0d0d0; --accent:#005f9e;
  --accent-active:#018642; --danger:#b12020; --warn:#ffb300;
  --lane-header-bg:#dfe8f1; --text:#000;
}
body.theme-aqua{ --bg:#edf4f7; --panel:#fff; --border:#c8dce5; --accent:#006ea8; --accent-active:#028f4a; --danger:#d2202f; --warn:#ffb300; --lane-header-bg:#d0e7f2; --text:#062233; }
body.theme-contrast{ --bg:#fff; --panel:#fff; --border:#000; --accent:#000; --accent-active:#1b7b1b; --danger:#c20000; --warn:#d67a00; --lane-header-bg:#f5f5f5; --text:#000; }
body.theme-dark{ --bg:#1b1f24; --panel:#2a3036; --border:#3a4148; --accent:#66aaff; --accent-active:#46c476; --danger:#ff6363; --warn:#ffb347; --lane-header-bg:#3a4752; --text:#fff; }

body{font-family:sans-serif;margin:0;background:var(--bg);line-height:1.3;color:var(--text);}
header{background:var(--panel);border-bottom:1px solid var(--border);padding:8px 12px;display:flex;justify-content:space-between;align-items:center;gap:6px;position:sticky;top:0;z-index:5;}
h1{font-size:.95rem;font-weight:700;margin:0;}
header a{font-size:.7rem;text-decoration:none;color:var(--accent);font-weight:600;}
.container{padding:8px 12px 40px;max-width:1100px;margin:0 auto;}
.panel{background:var(--panel);border:1px solid var(--border);border-radius:4px;padding:6px 6px 8px;margin-bottom:8px;}
.panel-title{font-weight:700;margin-bottom:4px;font-size:.75rem;}
.narrow-panel{max-width:520px;}
label{display:inline-block;margin-right:6px;margin-bottom:4px;font-size:.7rem;font-weight:600;}
select,input[type="number"],input[type="text"]{padding:3px 4px;border:1px solid #bbb;border-radius:4px;font-size:.7rem;font-weight:600;background:#fff;}
body.theme-dark select,body.theme-dark input[type="number"],body.theme-dark input[type="text"]{background:#1f2429;color:#fff;border-color:#4f5964;}
button{padding:3px 6px;border:none;border-radius:3px;background:var(--accent);color:#fff;cursor:pointer;font-size:.68rem;font-weight:700;}
button.small-btn{padding:2px 6px;min-width:26px}
button.danger{background:var(--danger)}
button.warn{background:var(--warn);color:#222}
button.btn-active{background:var(--accent-active)!important}
.small{font-size:.62rem;color:#c7c7c7;font-weight:500}
table{width:100%;border-collapse:collapse;background:var(--panel)}
thead th{background:#e6e6e6;border-bottom:1px solid var(--border);padding:3px 2px;text-align:center;font-size:.78rem;font-weight:700;color:#000}
body.theme-dark thead th{background:#3a4148;color:#fff}
tbody td{border-bottom:1px solid #eee;padding:2px 2px;text-align:center;vertical-align:middle;font-size:.75rem;font-weight:600}
body.theme-dark tbody td{border-bottom:1px solid #3a4148}
.lane-header{background:var(--lane-header-bg);font-weight:700}
.lane-header td{text-align:left;padding-left:4px}
.time-cell{font-family:monospace;font-size:.95rem;font-weight:700}
.row-inline{display:flex;flex-wrap:wrap;gap:5px;align-items:center}
.lane-buttons button{margin-right:4px;margin-bottom:4px}

/* Resumen */
#summaryPanel .summary-item{display:flex;justify-content:space-between;align-items:center;padding:3px 4px;background:var(--panel);border:1px solid var(--border);border-radius:3px;margin-bottom:4px}
#summaryPanel .summary-name{font-weight:700;font-size:1rem}
#summaryPanel .summary-time{font-family:monospace;font-weight:700;font-size:1rem}
#summaryPanel .splits{margin:2px 0 6px 0;font-family:monospace;font-size:.8rem;opacity:.9}

/* Activos compactos */
.active-row td{padding:4px 2px}
.live{font-family:monospace;font-weight:700}

/* Compacto en pantalla chica */
body.compact table,body.compact th,body.compact td{font-size:.72rem;font-weight:700}
body.compact .panel{padding:5px 5px 6px}
@media (max-width:750px){.row-inline{flex-direction:column;align-items:flex-start}.narrow-panel{max-width:100%}}
</style>
</head>
<body class="theme-dark">
<header>
  <h1>Cronos Natación</h1>
  <a href="#manual">Manual de uso</a>
</header>
<div class="container">

  <!-- CONFIG -->
  <div class="panel">
    <div class="panel-title">Config inicial</div>
    <div class="row-inline">
      <label>And: <input type="number" id="lanesInput" min="1" max="12" value="2"></label>
      <label>Nad/and: <input type="number" id="swimmersInput" min="1" max="10" value="4"></label>
      <label>Tema:
        <select id="themeSelect">
          <option value="theme-aqua">Acuático</option>
          <option value="theme-contrast">Alto contraste</option>
          <option value="theme-dark" selected>Oscuro</option>
        </select>
      </label>
      <button id="buildBtn">OK</button>
    </div>
    <div class="small">Después elegí la distancia.</div>
  </div>

  <!-- DISTANCIAS -->
  <div class="panel" id="distancePanel" style="display:none;">
    <div class="panel-title">Distancia</div>
    <div class="row-inline">
      <button class="small-btn" data-dist="40">40</button>
      <button class="small-btn" data-dist="100">100</button>
      <button class="small-btn" data-dist="200">200</button>
      <button class="small-btn" data-dist="400">400</button>
      <label>Otra: <input type="number" id="customDistance" min="1" style="width:70px;"></label>
      <button id="applyCustomDistance" class="small-btn">OK</button>
    </div>
    <div class="small">Al cambiar se limpian tiempos.</div>
  </div>

  <!-- SALIDAS -->
  <div class="panel" id="actionsPanel" style="display:none;">
    <div class="panel-title">Salidas por posición</div>
    <div class="row-inline"><div class="lane-buttons" id="posButtons"></div></div>
  </div>

  <!-- ACTIVOS -->
  <div class="panel narrow-panel" id="activePanel" style="display:none;">
    <div class="panel-title">Activos</div>
    <table><tbody id="activeBody"></tbody></table>
  </div>

  <!-- RESUMEN -->
  <div class="panel narrow-panel" id="summaryPanel" style="display:none;">
    <div class="panel-title">Resumen</div>
    <div id="summaryBody"></div>
  </div>

  <!-- GUARDAR -->
  <div class="panel" id="exportPanel" style="display:none;">
    <div class="panel-title">Guardar / reset</div>
    <div class="row-inline">
      <button id="exportCsvBtn">CSV</button>
      <button id="exportHtmlBtn">HTML</button>
      <button id="resetActBtn" class="warn">Reset act</button>
      <button id="resetBtn" class="danger">Reset</button>
    </div>
  </div>

  <!-- + NAD -->
  <div class="panel" id="laneAddPanel" style="display:none;">
    <div class="panel-title">+ Nad</div>
    <div class="row-inline" id="laneAddButtons"></div>
  </div>

  <!-- TABLA COMPLETA -->
  <table id="timesTable" style="display:none;">
    <thead>
      <tr><th style="width:10%">And</th><th>Nombre</th><th style="width:12%">Dist</th><th style="width:10%">S</th><th style="width:10%">F</th><th style="width:15%">t</th></tr>
    </thead>
    <tbody id="timesBody"></tbody>
  </table>

  <!-- MANUAL -->
  <div class="panel" id="manual">
    <div class="panel-title">Manual de uso</div>
    <ol class="small" style="line-height:1.4;">
      <li><b>Config inicial:</b> definís andariveles, nadadores y tema. “OK”.</li>
      <li><b>Distancia:</b> fija u otra.</li>
      <li><b>Salidas 1,2,3…:</b> larga a todos los de esa posición.</li>
      <li><b>Activos:</b> ves el tiempo en vivo. <b>INT</b> marca intervalos. <b>F</b> finaliza.</li>
      <li><b>Resumen:</b> muestra nombre, tiempo y los <b>intervalos</b>.</li>
    </ol>
  </div>
</div>

<script>
/* ===== Datos ===== */
var timesData = [];      // [lane][swimmer] = {name,start,end,distance,splits:[]}
var lanesCount = 0, baseSwimmersPerLane = 0, currentDistance = 0;

/* ===== DOM ===== */
var buildBtn = document.getElementById('buildBtn');
var lanesInput = document.getElementById('lanesInput');
var swimmersInput = document.getElementById('swimmersInput');
var themeSelect = document.getElementById('themeSelect');

var distancePanel = document.getElementById('distancePanel');
var customDistance = document.getElementById('customDistance');
var applyCustomDistance = document.getElementById('applyCustomDistance');

var actionsPanel = document.getElementById('actionsPanel');
var posButtons = document.getElementById('posButtons');

var activePanel = document.getElementById('activePanel');
var activeBody = document.getElementById('activeBody');

var summaryPanel = document.getElementById('summaryPanel');
var summaryBody = document.getElementById('summaryBody');

var exportPanel = document.getElementById('exportPanel');
var exportCsvBtn = document.getElementById('exportCsvBtn');
var exportHtmlBtn = document.getElementById('exportHtmlBtn');
var resetBtn = document.getElementById('resetBtn');
var resetActBtn = document.getElementById('resetActBtn');

var laneAddPanel = document.getElementById('laneAddPanel');
var laneAddButtons = document.getElementById('laneAddButtons');

var timesTable = document.getElementById('timesTable');
var timesBody = document.getElementById('timesBody');

/* ===== Util ===== */
function pad2(n){return (n<10?'0':'')+n;}
function formatClock(ts){var d=new Date(ts);return pad2(d.getHours())+':'+pad2(d.getMinutes())+':'+pad2(d.getSeconds());}
function formatDuration(ms){if(ms<0)ms=0;var total=Math.floor(ms/1000);var m=Math.floor(total/60);var s=total%60;var c=Math.floor((ms%1000)/10);return pad2(m)+':'+pad2(s)+'.'+pad2(c);}
function escapeHtml(str){return String(str).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#39;');}
function enableCompact(){document.body.classList.add('compact');}

/* ===== Tema ===== */
themeSelect.addEventListener('change',function(){applyTheme(themeSelect.value);});
function applyTheme(n){document.body.classList.remove('theme-aqua','theme-contrast','theme-dark');document.body.classList.add(n);}

/* ===== Build inicial ===== */
buildBtn.addEventListener('click',function(){
  var old=timesData, oldDist=currentDistance;
  lanesCount=parseInt(lanesInput.value,10)||1;
  baseSwimmersPerLane=parseInt(swimmersInput.value,10)||1;

  timesData=[];
  for(var l=0;l<lanesCount;l++){
    var arr=[];
    for(var s=0;s<baseSwimmersPerLane;s++){
      var prev=(old[l]&&old[l][s])?old[l][s]:null;
      arr.push({
        name: prev?prev.name:((l+1)+'_N'+(s+1)),
        start:null,end:null,
        distance: prev?(prev.distance||oldDist||0):(oldDist||0),
        splits: prev && prev.splits ? prev.splits.slice() : []
      });
    }
    timesData.push(arr);
  }
  currentDistance=oldDist||0;

  renderTable(); renderPositionButtons(); renderLaneAddButtons();
  renderActiveList(); renderSummary();

  distancePanel.style.display='block';
  actionsPanel.style.display='block';
  exportPanel.style.display='block';
  laneAddPanel.style.display='block';
  activePanel.style.display='block';
  summaryPanel.style.display='block';
});

/* ===== Distancias ===== */
distancePanel.addEventListener('click',function(e){
  var t=e.target||e.srcElement;
  if(t&&t.getAttribute('data-dist')){applyDistanceToAll(parseInt(t.getAttribute('data-dist'),10));}
});
applyCustomDistance.addEventListener('click',function(){
  var d=parseInt(customDistance.value,10); if(!isNaN(d)&&d>0)applyDistanceToAll(d);
});
function applyDistanceToAll(d){
  currentDistance=d;
  for(var l=0;l<timesData.length;l++){
    for(var s=0;s<timesData[l].length;s++){
      var sw=timesData[l][s];
      sw.distance=d; sw.start=null; sw.end=null; sw.splits=[];
    }
  }
  renderTable(); renderActiveList(); renderSummary(); renderPositionButtons();
}

/* ===== Tabla completa ===== */
function renderTable(){
  timesBody.innerHTML='';
  for(var l=0;l<timesData.length;l++){
    var laneTr=document.createElement('tr'); laneTr.className='lane-header';
    var laneTd=document.createElement('td'); laneTd.colSpan=6; laneTd.appendChild(document.createTextNode('Andarivel '+(l+1)));
    laneTr.appendChild(laneTd); timesBody.appendChild(laneTr);

    for(var s=0;s<timesData[l].length;s++){
      var sw=timesData[l][s], tr=document.createElement('tr');

      var tdEmpty=document.createElement('td'); tdEmpty.appendChild(document.createTextNode('')); tr.appendChild(tdEmpty);

      var tdName=document.createElement('td');
      var nameInput=document.createElement('input'); nameInput.type='text'; nameInput.value=sw.name; nameInput.style.width='100px';
      nameInput.setAttribute('data-lane',l); nameInput.setAttribute('data-swimmer',s); nameInput.onchange=handleNameChange;
      tdName.appendChild(nameInput); tr.appendChild(tdName);

      var tdDist=document.createElement('td'); tdDist.appendChild(document.createTextNode(sw.distance||0)); tr.appendChild(tdDist);

      var tdStart=document.createElement('td');
      var startBtn=document.createElement('button'); startBtn.appendChild(document.createTextNode('S')); startBtn.className='small-btn';
      startBtn.setAttribute('data-lane',l); startBtn.setAttribute('data-swimmer',s); startBtn.onclick=handleStartClick;
      tdStart.appendChild(startBtn);
      var startSpan=document.createElement('div'); startSpan.className='small'; startSpan.id='start-'+l+'-'+s;
      startSpan.appendChild(document.createTextNode(sw.start?formatClock(sw.start):'00:00:00')); tdStart.appendChild(startSpan);
      tr.appendChild(tdStart);

      var tdEnd=document.createElement('td');
      var endBtn=document.createElement('button'); endBtn.appendChild(document.createTextNode('F')); endBtn.className='small-btn';
      endBtn.setAttribute('data-lane',l); endBtn.setAttribute('data-swimmer',s); endBtn.onclick=handleEndClick;
      tdEnd.appendChild(endBtn);
      var endSpan=document.createElement('div'); endSpan.className='small'; endSpan.id='end-'+l+'-'+s;
      endSpan.appendChild(document.createTextNode(sw.end?formatClock(sw.end):'00:00:00')); tdEnd.appendChild(endSpan);
      tr.appendChild(tdEnd);

      var tdTime=document.createElement('td'); tdTime.id='time-'+l+'-'+s; tdTime.className='time-cell';
      tdTime.appendChild(document.createTextNode((sw.start&&sw.end)?formatDuration(sw.end-sw.start):'00:00.00')); tr.appendChild(tdTime);

      timesBody.appendChild(tr);
    }
  }
  timesTable.style.display='table';
}

/* ===== Activos + live counter + INT ===== */
var liveTimer=null;
function ensureLiveLoop(){
  if(liveTimer) return;
  liveTimer=setInterval(function(){
    var now=Date.now();
    // actualiza todos los spans .live con data-l y data-s
    var nodes=document.getElementsByClassName('live');
    for(var i=0;i<nodes.length;i++){
      var n=nodes[i];
      var l=parseInt(n.getAttribute('data-l'),10), s=parseInt(n.getAttribute('data-s'),10);
      var sw=timesData[l][s];
      if(sw && sw.start!==null && sw.end===null){
        n.innerHTML=formatDuration(now - sw.start);
      }
    }
  },100);
}

function renderActiveList(){
  activeBody.innerHTML='';
  var has=false;
  for(var l=0;l<timesData.length;l++){
    var laneHas=false;
    for(var s=0;s<timesData[l].length;s++){
      if(timesData[l][s].start!==null && timesData[l][s].end===null){laneHas=true;break;}
    }
    if(!laneHas) continue;
    has=true;

    var laneTr=document.createElement('tr'); laneTr.className='lane-header';
    var laneTd=document.createElement('td'); laneTd.colSpan=4; laneTd.appendChild(document.createTextNode('Andarivel '+(l+1)));
    laneTr.appendChild(laneTd); activeBody.appendChild(laneTr);

    for(var s2=0;s2<timesData[l].length;s2++){
      var sw2=timesData[l][s2];
      if(sw2.start!==null && sw2.end===null){
        var tr=document.createElement('tr'); tr.className='active-row';

        var tdName=document.createElement('td'); tdName.appendChild(document.createTextNode(sw2.name||'')); tr.appendChild(tdName);

        var tdLive=document.createElement('td');
        var liveSpan=document.createElement('span'); liveSpan.className='live'; liveSpan.setAttribute('data-l',l); liveSpan.setAttribute('data-s',s2);
        liveSpan.appendChild(document.createTextNode('00:00.00')); tdLive.appendChild(liveSpan);
        tr.appendChild(tdLive);

        var tdInt=document.createElement('td');
        var intBtn=document.createElement('button'); intBtn.className='small-btn warn'; intBtn.appendChild(document.createTextNode('INT'));
        intBtn.setAttribute('data-lane',l); intBtn.setAttribute('data-swimmer',s2); intBtn.onclick=handleSplitClick;
        tdInt.appendChild(intBtn); tr.appendChild(tdInt);

        var tdBtn=document.createElement('td');
        var endBtn=document.createElement('button'); endBtn.className='small-btn'; endBtn.appendChild(document.createTextNode('F'));
        endBtn.setAttribute('data-lane',l); endBtn.setAttribute('data-swimmer',s2); endBtn.onclick=handleEndClick;
        tdBtn.appendChild(endBtn); tr.appendChild(tdBtn);

        activeBody.appendChild(tr);
      }
    }
  }
  activePanel.style.display=has?'block':'none';
  if(has) ensureLiveLoop();
}

/* ===== Resumen (incluye splits) ===== */
function renderSummary(){
  summaryBody.innerHTML='';
  var any=false;
  for(var l=0;l<timesData.length;l++){
    for(var s=0;s<timesData[l].length;s++){
      var sw=timesData[l][s];
      if(sw.start!==null){ // mostrar aunque no haya finalizado, así se ven los INT
        any=true;
        var div=document.createElement('div'); div.className='summary-item';

        var left=document.createElement('div'); left.className='summary-name'; left.appendChild(document.createTextNode(sw.name||'')); div.appendChild(left);

        var right=document.createElement('div'); right.className='summary-time';
        var main = (sw.start&&sw.end)?formatDuration(sw.end-sw.start):'—';
        right.appendChild(document.createTextNode(main)); div.appendChild(right);

        summaryBody.appendChild(div);

        // Splits
        if(sw.splits && sw.splits.length){
          var p=document.createElement('div'); p.className='splits';
          var arr=[]; for(var k=0;k<sw.splits.length;k++){arr.push(formatDuration(sw.splits[k]-sw.start));}
          p.appendChild(document.createTextNode('INT: '+arr.join(' | '))); summaryBody.appendChild(p);
        }
      }
    }
  }
  summaryPanel.style.display=any?'block':'none';
}

/* ===== Botonera por posición ===== */
function renderPositionButtons(){
  posButtons.innerHTML='';
  var max=getMaxSwimmersAcrossLanes();
  for(var p=0;p<max;p++){
    (function(idx){
      var b=document.createElement('button'); b.className='small-btn'; b.appendChild(document.createTextNode(idx+1));
      b.onclick=function(){ enableCompact(); startPosition(idx); };
      posButtons.appendChild(b);
    })(p);
  }
}
function startPosition(posIndex){
  var now=Date.now();
  for(var l=0;l<timesData.length;l++){
    if(timesData[l][posIndex]) setStartTime(l,posIndex,now);
  }
  renderActiveList(); renderSummary();
}

/* ===== + Nad ===== */
function renderLaneAddButtons(){
  laneAddButtons.innerHTML='';
  for(var l=0;l<timesData.length;l++){
    (function(li){
      var b=document.createElement('button'); b.className='small-btn'; b.appendChild(document.createTextNode('+'+(li+1)));
      b.onclick=function(){
        timesData[li].push({name:(li+1)+'_N'+(timesData[li].length+1),start:null,end:null,distance:currentDistance,splits:[]});
        renderTable(); renderPositionButtons(); renderActiveList(); renderSummary();
      };
      laneAddButtons.appendChild(b);
    })(l);
  }
}

/* ===== Handlers ===== */
function handleNameChange(e){
  var l=parseInt(e.target.getAttribute('data-lane'),10), s=parseInt(e.target.getAttribute('data-swimmer'),10);
  timesData[l][s].name=e.target.value; renderActiveList(); renderSummary();
}
function handleStartClick(e){
  var l=parseInt(e.target.getAttribute('data-lane'),10), s=parseInt(e.target.getAttribute('data-swimmer'),10);
  enableCompact(); setStartTime(l,s,Date.now()); renderActiveList(); renderSummary();
}
function handleEndClick(e){
  var l=parseInt(e.target.getAttribute('data-lane'),10), s=parseInt(e.target.getAttribute('data-swimmer'),10);
  setEndTime(l,s,Date.now()); renderActiveList(); renderSummary();
}
function handleSplitClick(e){
  var l=parseInt(e.target.getAttribute('data-lane'),10), s=parseInt(e.target.getAttribute('data-swimmer'),10);
  var sw=timesData[l][s];
  if(sw.start!==null && sw.end===null){
    if(!sw.splits) sw.splits=[];
    sw.splits.push(Date.now());
    renderSummary(); // mostrar el nuevo INT debajo
  }
}

/* ===== Setters de tiempo ===== */
function setStartTime(l,s,ts){
  var sw=timesData[l][s]; sw.start=ts; sw.end=null; sw.splits=[];
  var sp=document.getElementById('start-'+l+'-'+s); if(sp) sp.innerHTML=formatClock(ts);
  var tc=document.getElementById('time-'+l+'-'+s); if(tc) tc.innerHTML='00:00.00';
}
function setEndTime(l,s,ts){
  var sw=timesData[l][s]; sw.end=ts;
  var sp=document.getElementById('end-'+l+'-'+s); if(sp) sp.innerHTML=formatClock(ts);
  var tc=document.getElementById('time-'+l+'-'+s); if(tc) tc.innerHTML=(sw.start&&sw.end)?formatDuration(sw.end-sw.start):'00:00.00';
}

/* ===== Reset ===== */
resetBtn.addEventListener('click',function(){
  if(!confirm('Resetear todos los tiempos?'))return;
  for(var l=0;l<timesData.length;l++){for(var s=0;s<timesData[l].length;s++){var sw=timesData[l][s]; sw.start=null; sw.end=null; sw.splits=[];}}
  renderTable(); renderActiveList(); renderPositionButtons(); renderSummary();
});
resetActBtn.addEventListener('click',function(){
  for(var l=0;l<timesData.length;l++){for(var s=0;s<timesData[l].length;s++){var sw=timesData[l][s]; if(sw.start!==null&&sw.end===null){sw.start=null; sw.end=null; sw.splits=[];}}}
  renderTable(); renderActiveList(); renderSummary();
});

/* ===== Export ===== */
exportCsvBtn.addEventListener('click',function(){
  var csv='andarivel,nadador,distancia,salida,fin,tiempo,intervalos\n';
  for(var l=0;l<timesData.length;l++){
    for(var s=0;s<timesData[l].length;s++){
      var sw=timesData[l][s];
      var startStr=sw.start?formatClock(sw.start):'00:00:00';
      var endStr=sw.end?formatClock(sw.end):'00:00:00';
      var durStr=(sw.start&&sw.end)?formatDuration(sw.end-sw.start):'';
      var ints='';
      if(sw.splits&&sw.start){var tmp=[];for(var k=0;k<sw.splits.length;k++){tmp.push(formatDuration(sw.splits[k]-sw.start));}ints=tmp.join(' | ');}
      csv+=(l+1)+',"'+(sw.name||'')+'",'+(sw.distance||0)+','+startStr+','+endStr+','+durStr+',"'+ints+'"\n';
    }
  }
  downloadFile(csv,'text/csv','resultados_natacion.csv');
});
exportHtmlBtn.addEventListener('click',function(){
  var html='<!DOCTYPE html><html><head><meta charset="UTF-8"><title>Resultados natación</title></head><body>';
  html+='<h2>Resultados de natación</h2><table border="1" cellpadding="4" cellspacing="0">';
  html+='<tr><th>And</th><th>Nombre</th><th>Dist</th><th>Salida</th><th>Fin</th><th>t</th><th>intervalos</th></tr>';
  for(var l=0;l<timesData.length;l++){
    for(var s=0;s<timesData[l].length;s++){
      var sw=timesData[l][s];
      var startStr=sw.start?formatClock(sw.start):'00:00:00';
      var endStr=sw.end?formatClock(sw.end):'00:00:00';
      var durStr=(sw.start&&sw.end)?formatDuration(sw.end-sw.start):'';
      var ints='';
      if(sw.splits&&sw.start){var tmp=[];for(var k=0;k<sw.splits.length;k++){tmp.push(formatDuration(sw.splits[k]-sw.start));}ints=tmp.join(' | ');}
      html+='<tr><td>'+(l+1)+'</td><td>'+escapeHtml(sw.name||'')+'</td><td>'+(sw.distance||0)+'</td><td>'+startStr+'</td><td>'+endStr+'</td><td>'+durStr+'</td><td>'+escapeHtml(ints)+'</td></tr>';
    }
  }
  html+='</table><p>Generado: '+new Date().toLocaleString()+'</p></body></html>';
  downloadFile(html,'text/html','resultados_natacion.html');
});

function getMaxSwimmersAcrossLanes(){var m=0;for(var l=0;l<timesData.length;l++){if(timesData[l].length>m)m=timesData[l].length;}return m;}
function downloadFile(content,mime,filename){
  var blob=new Blob([content],{type:mime}); var url=URL.createObjectURL(blob);
  var a=document.createElement('a'); a.href=url; a.download=filename; document.body.appendChild(a); a.click();
  setTimeout(function(){document.body.removeChild(a); URL.revokeObjectURL(url);},1000);
}

/* inicia loop de live cuando haga falta */
ensureLiveLoop();
</script>
</body>
</html>
